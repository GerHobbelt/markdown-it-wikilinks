{"version":3,"file":"markdownItWikiLinks.modern.js","sources":["../index.js"],"sourcesContent":["\nimport createPlugin from '@gerhobbelt/markdown-it-regexp';\nimport sanitize from 'sanitize-filename';\n\n\n\nfunction removeInitialSlashes(str) {\n  return str.replace(/^\\/+/g, '');\n}\n\n// separate the setup/config object from the `md.use(...)` call for code clarity:\nconst defaultSetup = {\n  pluginId: 'wikilink',\n  replacer: function wikilinksReplacer(match, setup, options, env, tokens, id, md_options) {\n    let label = '';\n    let pageName = '';\n    let href = '';\n    let htmlAttrs = [];\n    const isSplit = !!match[2];\n\n    function isAbsolute(pageName) {\n      return options.makeAllLinksAbsolute || pageName.charCodeAt(0) === 0x2F;/* / */\n    }\n\n    if (isSplit) {\n      label = match[3];\n      pageName = match[1];\n    } else {\n      label = match[1];\n      pageName = options.generatePageNameFromLabel(label);\n    }\n    let originalLabel = label;\n    let originalPageName = pageName;\n    label = options.postProcessLabel(label);\n    pageName = options.postProcessPageName(pageName);\n\n    // make sure none of the values are empty\n    if (!label || !pageName) {\n      return match.input;\n    }\n\n    if (isAbsolute(pageName)) {\n      pageName = removeInitialSlashes(pageName);\n      href = options.baseURL + pageName + options.uriSuffix;\n    } else {\n      href = options.relativeBaseURL + pageName + options.uriSuffix;\n    }\n    href = setup.escape(href);\n\n    htmlAttrs.push(`href=\"${href}\"`);\n    for (let attrName in options.htmlAttributes) {\n      const attrValue = options.htmlAttributes[attrName];\n      htmlAttrs.push(`${attrName}=\"${setup.encodeHtmlAttr(attrValue)}\"`);\n    }\n\n    const info = {\n      pageName,\n      label,\n      originalPageName,\n      originalLabel,\n      href,\n      htmlAttrs\n    };\n    // and augment the parse token too:\n    tokens[id].__wikilinksInfo = info;\n    return this.renderLink(info, setup, options, env, tokens, id);\n\n    // - showcase using the `options` passed in via `MarkdownIt.use()`\n    // - showcase using the `setup` object\n    // - showcase using the `tokens` stream + `id` index to access the token\n    // return '\\n' + setup.pluginId + ':' + options.opt1 + ':' + setup.escape(url) + ':' + options.opt2 + ':' + (token.wonko || '---') + ':' + token.type + ':' + token.nesting + ':' + token.level;\n  },\n  renderLink: function wikilinksRenderLink(info, setup, options, env, tokens, id) {\n    let htmlAttrsString = info.htmlAttrs.join(' ');\n\n    return `<a ${htmlAttrsString}>${info.label}</a>`;\n  },\n  setup: function wikilinksSetup(config, options) {\n    const defaults = {\n      linkPattern: /\\[\\[([^\\x00-\\x1f|]+?)(\\|([\\s\\S]+?))?\\]\\]/,          // accept anything, except control characters (CR, LF, etc) or |\n      // linkPattern: /\\[\\[([-.\\w\\s\\/]+)(\\|([-.\\w\\s\\/]+))?\\]\\]/,          // accept words, dashes, dots and whitespace\n\n      baseURL: '/',\n      relativeBaseURL: './',\n      makeAllLinksAbsolute: false,\n      uriSuffix: '.html',\n      htmlAttributes: {\n      },\n      generatePageNameFromLabel: (label) => {\n        return label;\n      },\n      postProcessPageName: (pageName) => {\n        pageName = pageName.trim();\n        pageName = pageName.split('/').map(sanitize).join('/');\n        pageName = pageName.replace(/\\s+/g, '_');\n        return pageName;\n      },\n      postProcessLabel: (label) => {\n        label = label.trim();\n        return label;\n      }\n    };\n\n    options = Object.assign({}, defaults, options);\n\n    // override the regexp used for token matching:\n    if (options.linkPattern) {\n      config.regexp = options.linkPattern;\n    }\n\n    return options;\n  }\n};\n\nconst plugin = createPlugin(\n  // regexp to match: fake one. Will be set up by setup callback instead.\n  /./,\n\n  Object.assign({}, defaultSetup)\n);\n\n// only use this for test rigs:\nplugin.createTestInstance = function (setup) {\n  createPlugin.reset();\n  let setupObj = null;\n  if (setup) {\n    // allow user-provided setup to 'postprocess' the default setup:\n    setupObj = {\n      setup: function customSetup(config, options) {\n        options = this.originalSetup(config, options);\n        options = this.userSetup(config, options);\n        return options;\n      },\n      originalSetup: defaultSetup.setup,\n      userSetup: setup\n    };\n  }\n  const p = createPlugin(\n    // regexp to match: fake one. Will be set up by setup callback instead.\n    /./,\n\n    Object.assign({}, defaultSetup, setupObj)\n  );\n  return p;\n};\n\n\nexport default plugin;\n"],"names":["removeInitialSlashes","str","replace","defaultSetup","pluginId","replacer","wikilinksReplacer","match","setup","options","env","tokens","id","md_options","label","pageName","href","htmlAttrs","isSplit","isAbsolute","makeAllLinksAbsolute","charCodeAt","generatePageNameFromLabel","originalLabel","originalPageName","postProcessLabel","postProcessPageName","input","baseURL","uriSuffix","relativeBaseURL","escape","push","attrName","htmlAttributes","attrValue","encodeHtmlAttr","info","__wikilinksInfo","renderLink","wikilinksRenderLink","htmlAttrsString","join","wikilinksSetup","config","defaults","linkPattern","trim","split","map","sanitize","Object","assign","regexp","plugin","createPlugin","createTestInstance","reset","setupObj","customSetup","originalSetup","userSetup","p"],"mappings":"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"}